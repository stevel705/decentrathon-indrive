# Тренировка YOLO модели для детекции повреждений автомобилей

## Подготовка данных

### Структура датасета
Создайте следующую структуру папок:

```
data/
├── images/
│   ├── train/          # Тренировочные изображения
│   │   ├── img1.jpg
│   │   ├── img2.jpg
│   │   └── ...
│   ├── val/            # Валидационные изображения  
│   │   ├── img1.jpg
│   │   ├── img2.jpg
│   │   └── ...
│   └── test/           # Тестовые изображения (опционально)
│       ├── img1.jpg
│       └── ...
└── labels/
    ├── train/          # Аннотации для тренировки
    │   ├── img1.txt
    │   ├── img2.txt
    │   └── ...
    ├── val/            # Аннотации для валидации
    │   ├── img1.txt
    │   ├── img2.txt
    │   └── ...
    └── test/           # Аннотации для теста (опционально)
        ├── img1.txt
        └── ...
```

### Формат аннотаций YOLO

Каждый файл `.txt` содержит аннотации в формате YOLO:
```
class_id center_x center_y width height
```

Где:
- `class_id` - ID класса (0-7 для наших классов повреждений)
- `center_x, center_y` - центр bounding box (нормализованные 0-1)
- `width, height` - размеры bounding box (нормализованные 0-1)

Пример файла аннотации:
```
0 0.5 0.3 0.2 0.4    # damaged_door
4 0.7 0.6 0.15 0.2   # dent
```

### Классы повреждений

| ID | Класс | Описание |
|----|-------|----------|
| 0 | damaged_door | Повреждённая дверь |
| 1 | damaged_window | Повреждённое окно |
| 2 | damaged_headlight | Повреждённая фара |
| 3 | damaged_mirror | Повреждённое зеркало |
| 4 | dent | Вмятина |
| 5 | damaged_hood | Повреждённый капот |
| 6 | damaged_bumper | Повреждённый бампер |
| 7 | damaged_windshield | Повреждённое лобовое стекло |

## Быстрый старт



### 2. Продвинутая тренировка

```bash
# Полная тренировка с настройками
python yolo_train.py --data data --epochs 100 --batch 16 --model yolov8s.pt

# Только оценка существующей модели
python yolo_train.py --data data --eval-only runs/damage_detection/weights/best.pt

# Конвертация в ONNX для деплоя
python yolo_train.py --export-onnx runs/damage_detection/weights/best.pt

# Создать пример скрипта
python yolo_train.py --create-example
```

### 3. Параметры командной строки

```bash
python yolo_train.py \
    --data data \                      # Путь к датасету
    --model yolov8n.pt \              # Размер модели (n/s/m/l/x)
    --epochs 100 \                    # Количество эпох
    --batch 16 \                      # Размер батча
    --imgsz 640 \                     # Размер изображения
    --lr 0.01 \                       # Скорость обучения
    --device auto \                   # Устройство (auto/cpu/0/1)
    --project runs/damage_detection \ # Папка проекта
    --name experiment_1 \             # Имя эксперимента
    --resume                          # Продолжить тренировку
```

## Размеры моделей YOLOv8

| Модель | Размер | Скорость | Точность | Рекомендации |
|--------|--------|----------|----------|--------------|
| yolov8n.pt | ~6MB | Очень быстро | Базовая | Быстрое прототипирование |
| yolov8s.pt | ~22MB | Быстро | Хорошая | Балансированный выбор |
| yolov8m.pt | ~52MB | Средне | Отличная | Производство |
| yolov8l.pt | ~87MB | Медленно | Очень хорошая | Высокая точность |
| yolov8x.pt | ~137MB | Очень медленно | Максимальная | Исследования |

## Мониторинг тренировки

### TensorBoard (если установлен)
```bash
# Запуск TensorBoard для мониторинга
tensorboard --logdir runs/damage_detection
```

### Файлы результатов
После тренировки в папке `runs/damage_detection/experiment_name/` будут созданы:

- `weights/best.pt` - лучшая модель
- `weights/last.pt` - последняя модель  
- `results.png` - графики метрик
- `confusion_matrix.png` - матрица ошибок
- `PR_curve.png` - Precision-Recall кривая
- `F1_curve.png` - F1 кривая
- `train_batch*.jpg` - примеры тренировочных батчей
- `val_batch*_pred.jpg` - предсказания на валидации

## Оценка качества

### Основные метрики
- **mAP@0.5** - средняя точность при IoU=0.5
- **mAP@0.5:0.95** - средняя точность при IoU от 0.5 до 0.95
- **Precision** - точность (доля правильных детекций)
- **Recall** - полнота (доля найденных объектов)

### Хорошие значения для детекции повреждений
- mAP@0.5 > 0.7 - хорошо
- mAP@0.5 > 0.8 - отлично
- mAP@0.5 > 0.9 - превосходно

## Использование натренированной модели

```python
from ultralytics import YOLO

# Загрузка модели
model = YOLO('runs/damage_detection/weights/best.pt')

# Предсказание на изображении
results = model('path/to/car_image.jpg')

# Обработка результатов
for result in results:
    boxes = result.boxes.data.cpu().numpy()
    for box in boxes:
        x1, y1, x2, y2, conf, cls = box
        if conf > 0.5:  # порог уверенности
            print(f"Класс: {model.names[int(cls)]}, Уверенность: {conf:.2f}")
```

## Советы по улучшению качества

### 1. Данные
- **Разнообразие**: разные углы, освещение, типы автомобилей
- **Качество аннотаций**: точные bounding box'ы
- **Баланс классов**: примерно одинаковое количество примеров каждого класса
- **Размер датасета**: минимум 100-200 изображений на класс

### 2. Аугментации
- Включите горизонтальные флипы (fliplr=0.5)
- Небольшие повороты (degrees=10-15)
- Вариации яркости/контрастности (hsv_*)
- Осторожно с вертикальными флипами для автомобилей

### 3. Гиперпараметры
- Начните с малой скорости обучения (lr0=0.001-0.01)
- Используйте ранню остановку (patience=10-20)
- Подберите оптимальный размер батча под вашу GPU

### 4. Валидация
- Используйте отдельный валидационный набор (20-30% данных)
- Не переобучайтесь - следите за валидационными метриками
- Тестируйте на реальных данных

## Устранение проблем

### Низкое качество детекции
1. Проверьте качество аннотаций
2. Увеличьте размер датасета
3. Попробуйте большую модель (s/m вместо n)
4. Настройте аугментации
5. Уменьшите скорость обучения

### Переобучение
1. Уменьшите количество эпох
2. Используйте дропаут и регуляризацию
3. Увеличьте валидационный набор
4. Добавьте больше аугментаций

### Медленная тренировка
1. Уменьшите размер изображения (imgsz=416)
2. Используйте меньшую модель (yolov8n)
3. Увеличьте размер батча
4. Используйте GPU вместо CPU

## Интеграция с приложением

После тренировки скопируйте лучшую модель в папку weights:

```bash
cp runs/damage_detection/weights/best.pt weights/best_yolo_damage.pt
```

Модель автоматически будет использоваться в `app.py` для детекции повреждений.
